<!DOCTYPE html><html lang="en"><head><title>vendor/assets/javascripts/railsy_backbone.sync</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../"><meta name="groc-document-path" content="vendor/assets/javascripts/railsy_backbone.sync"><meta name="groc-project-path" content="vendor/assets/javascripts/railsy_backbone.sync.js"><meta name="groc-github-url" content="https://github.com/westonplatter/railsy-backbone"><link rel="stylesheet" type="text/css" media="all" href="../../../assets/style.css"><script type="text/javascript" src="../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/westonplatter/railsy-backbone/blob/master/vendor/assets/javascripts/railsy_backbone.sync.js">vendor/assets/javascripts/railsy_backbone.sync.js</a></div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><p><strong>NOTE:</strong> only overriding Backbone when <code>railsy_backbone (start) ... (end)</code> 
is explicitly called out.</p>

<p>Overriding Backbone.sync to implement, <br />
- Nested model attributes <br />
- Rails CSFR Integration  </p></div></div><div class="code"><div class="wrapper"><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">){</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Define <code>methodMap</code> since it's called from within Backbone.sync</p></div></div><div class="code"><div class="wrapper">  <span class="kd">var</span> <span class="nx">methodMap</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s1">&#39;create&#39;</span><span class="o">:</span> <span class="s1">&#39;POST&#39;</span><span class="p">,</span>
      <span class="s1">&#39;update&#39;</span><span class="o">:</span> <span class="s1">&#39;PUT&#39;</span><span class="p">,</span>
      <span class="s1">&#39;patch&#39;</span><span class="o">:</span>  <span class="s1">&#39;PATCH&#39;</span><span class="p">,</span>
      <span class="s1">&#39;delete&#39;</span><span class="o">:</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">,</span>
      <span class="s1">&#39;read&#39;</span><span class="o">:</span>   <span class="s1">&#39;GET&#39;</span>
    <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">urlError</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;A &#39;url&#39; property or function must be specified&quot;</span><span class="p">);</span>
  <span class="p">};</span>

  <span class="nx">Backbone</span><span class="p">.</span><span class="nx">sync</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">methodMap</span><span class="p">[</span><span class="nx">method</span><span class="p">];</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Default options, unless specified.</p></div></div><div class="code"><div class="wrapper">    <span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span><span class="p">(</span><span class="nx">options</span> <span class="o">||</span> <span class="p">(</span><span class="nx">options</span> <span class="o">=</span> <span class="p">{}),</span> <span class="p">{</span>
      <span class="nx">emulateHTTP</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">emulateHTTP</span><span class="p">,</span>
      <span class="nx">emulateJSON</span><span class="o">:</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">emulateJSON</span>
    <span class="p">});</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Default JSON-request options.</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">{</span><span class="nx">type</span><span class="o">:</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;json&#39;</span><span class="p">};</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Ensure that we have a URL.</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">params</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">result</span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="s1">&#39;url&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">urlError</span><span class="p">();</span>
    <span class="p">}</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>railsy_backbone (start) <br />
<strong>Rails CSFR Integration</strong>  </p>

<p>include the Rails CSRF token on HTTP PUTs/POSTs    </p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">noCSRF</span><span class="p">){</span>
      <span class="kd">var</span> <span class="nx">beforeSend</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">beforeSend</span><span class="p">;</span>
      </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Set X-CSRF-Token HTTP header</p></div></div><div class="code"><div class="wrapper">      <span class="nx">options</span><span class="p">.</span><span class="nx">beforeSend</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">token</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;meta[name=&quot;csrf-token&quot;]&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;content&#39;</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">&#39;X-CSRF-Token&#39;</span><span class="p">,</span> <span class="nx">token</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">beforeSend</span><span class="p">)</span> <span class="k">return</span> <span class="nx">beforeSend</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
      <span class="p">};</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>railsy_backbone (end)</p>

<hr /></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Ensure that we have the appropriate request data.</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">data</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">model</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;create&#39;</span> <span class="o">||</span> <span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;update&#39;</span> <span class="o">||</span> <span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;patch&#39;</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">params</span><span class="p">.</span><span class="nx">contentType</span> <span class="o">=</span> <span class="s1">&#39;application/json&#39;</span><span class="p">;</span>
      </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><hr />

<p>railsy_backbone (start) <br />
<strong>Nested Model Attributes</strong>  </p>

<p>If Backbone.Model defines <code>paramRoot</code>, then store model attributes 
within <code>paramRoot</code> key-value pair. For example, book attributes 
(<code>title</code>, <code>author</code>) are nested within <code>book</code> key-value pair,</p>

<pre><code> var Book = Backbone.Model.extend({ 
   url: '/books',
   paramRoot: 'book' 
 });

 var book_instance = new Book({ 
   title:  'the illiad', 
   author: 'homer'
 });
</code></pre>

<p>The resulting HTTP POST looks like this,</p>

<pre><code> book_instance.sync();

 Started POST "/books" for 127.0.0.1
   Processing by BooksController#create as JSON
   { "book" =&gt; { "title" =&gt; "the illiad", "author" =&gt; "home", "id" =&gt; 1} }
</code></pre></div></div><div class="code"><div class="wrapper">      <span class="k">if</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">paramRoot</span><span class="p">)</span> <span class="p">{</span>        
        <span class="kd">var</span> <span class="nx">model_attributes</span> <span class="o">=</span> <span class="p">{}</span>
        </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Store model instance in JSON format.</p></div></div><div class="code"><div class="wrapper">        <span class="kd">var</span> <span class="nx">attrs</span> <span class="o">=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">(</span><span class="nx">options</span><span class="p">);</span>
        </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Remove Rails unofficially reserved <code>created_at</code> and <code>updated_at</code> so 
they're included in HTTP PUT/PATCH request.</p></div></div><div class="code"><div class="wrapper">        <span class="k">delete</span> <span class="nx">attrs</span><span class="p">[</span><span class="s2">&quot;created_at&quot;</span><span class="p">];</span>
        <span class="k">delete</span> <span class="nx">attrs</span><span class="p">[</span><span class="s2">&quot;updated_at&quot;</span><span class="p">];</span>
        </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Nest model attributes within model's <code>paramRoot</code> key-value pair.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">model_attributes</span><span class="p">[</span><span class="nx">model</span><span class="p">.</span><span class="nx">paramRoot</span><span class="p">]</span> <span class="o">=</span> <span class="nx">attrs</span><span class="p">;</span>
        
        <span class="nx">params</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">attrs</span> <span class="o">||</span> <span class="nx">model_attributes</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If model does not define a <code>paramRoot</code>, use the original Backbone 
implementation.</p></div></div><div class="code"><div class="wrapper">        <span class="nx">params</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">attrs</span> <span class="o">||</span> <span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">);</span>
      <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>railsy_backbone (end)  </p>

<hr /></div></div><div class="code"><div class="wrapper">    <span class="p">}</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>For older servers, emulate JSON by encoding the request into an HTML-form.</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">emulateJSON</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">params</span><span class="p">.</span><span class="nx">contentType</span> <span class="o">=</span> <span class="s1">&#39;application/x-www-form-urlencoded&#39;</span><span class="p">;</span>
      <span class="nx">params</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">params</span><span class="p">.</span><span class="nx">data</span> <span class="o">?</span> <span class="p">{</span><span class="nx">model</span><span class="o">:</span> <span class="nx">params</span><span class="p">.</span><span class="nx">data</span><span class="p">}</span> <span class="o">:</span> <span class="p">{};</span>
    <span class="p">}</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>For older servers, emulate HTTP by mimicking the HTTP method with <code>_method</code>
And an <code>X-HTTP-Method-Override</code> header.</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">emulateHTTP</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;PUT&#39;</span> <span class="o">||</span> <span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;DELETE&#39;</span> <span class="o">||</span> <span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;PATCH&#39;</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">params</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;POST&#39;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">emulateJSON</span><span class="p">)</span> <span class="nx">params</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">_method</span> <span class="o">=</span> <span class="nx">type</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">beforeSend</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">beforeSend</span><span class="p">;</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">beforeSend</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">xhr</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s1">&#39;X-HTTP-Method-Override&#39;</span><span class="p">,</span> <span class="nx">type</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">beforeSend</span><span class="p">)</span> <span class="k">return</span> <span class="nx">beforeSend</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">);</span>
      <span class="p">};</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Don't process data on a non-GET request.</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">type</span> <span class="o">!==</span> <span class="s1">&#39;GET&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">emulateJSON</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">params</span><span class="p">.</span><span class="nx">processData</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If we're sending a <code>PATCH</code> request, and we're in an old Internet Explorer
that still has ActiveX enabled by default, override jQuery to use that
for XHR instead. Remove this line when jQuery supports <code>PATCH</code> on IE8.</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">&#39;PATCH&#39;</span> <span class="o">&amp;&amp;</span> <span class="nb">window</span><span class="p">.</span><span class="nx">ActiveXObject</span> <span class="o">&amp;&amp;</span>
        <span class="o">!</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">external</span> <span class="o">&amp;&amp;</span> <span class="nb">window</span><span class="p">.</span><span class="nx">external</span><span class="p">.</span><span class="nx">msActiveXFilteringEnabled</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">params</span><span class="p">.</span><span class="nx">xhr</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">ActiveXObject</span><span class="p">(</span><span class="s2">&quot;Microsoft.XMLHTTP&quot;</span><span class="p">);</span>
      <span class="p">};</span>
    <span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Make the request, allowing the user to override any Ajax options.</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">xhr</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="nx">options</span><span class="p">));</span>
    <span class="nx">model</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">xhr</span><span class="p">;</span>
  <span class="p">};</span>

<span class="p">})(</span><span class="nx">jQuery</span><span class="p">);</span></div></div></div></div></body></html>